# Web Service Makefile

.PHONY: help install build test clean docker-build docker-run dev

# é»˜è®¤ç›®æ ‡
help:
	@echo "Web Service å¯ç”¨å‘½ä»¤:"
	@echo "  install      - å®‰è£…å‰ç«¯å’Œåç«¯ä¾èµ–"
	@echo "  build        - æ„å»ºå‰ç«¯åº”ç”¨"
	@echo "  test         - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  docker-build - æ„å»ºDockeré•œåƒ"
	@echo "  docker-run   - è¿è¡ŒDockerå®¹å™¨"
	@echo "  dev          - å¯åŠ¨å¼€å‘ç¯å¢ƒ"

# å®‰è£…ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
	cd frontend && npm install
	@echo "ğŸ å®‰è£…åç«¯ä¾èµ–..."
	pip install -r requirements.txt
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# æ„å»ºå‰ç«¯
build:
	@echo "ğŸ”¨ æ„å»ºå‰ç«¯åº”ç”¨..."
	cd frontend && npm run build
	@echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	python test-integration.py

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -rf frontend/dist
	rm -rf frontend/node_modules
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ„å»ºDockeré•œåƒ
docker-build:
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	docker build -t technical-analyst-web-service .
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"

# è¿è¡ŒDockerå®¹å™¨
docker-run:
	@echo "ğŸš€ è¿è¡ŒDockerå®¹å™¨..."
	docker run -d --name web-service-test -p 8005:8000 technical-analyst-web-service
	@echo "âœ… å®¹å™¨å¯åŠ¨å®Œæˆï¼Œè®¿é—® http://localhost:8005"

# å¼€å‘ç¯å¢ƒ
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	@echo "å‰ç«¯: http://localhost:3000"
	@echo "åç«¯: http://localhost:8000"
	@echo "æŒ‰ Ctrl+C åœæ­¢æœåŠ¡"
	@cd frontend && npm run dev & \
	uvicorn app.main:app --reload --port 8000 & \
	wait

# åœæ­¢å¼€å‘ç¯å¢ƒ
dev-stop:
	@echo "ğŸ›‘ åœæ­¢å¼€å‘ç¯å¢ƒ..."
	pkill -f "npm run dev" || true
	pkill -f "uvicorn" || true
	@echo "âœ… å¼€å‘ç¯å¢ƒå·²åœæ­¢"

# å®Œæ•´æ„å»ºæµç¨‹
all: install build test
	@echo "ğŸ‰ å®Œæ•´æ„å»ºæµç¨‹å®Œæˆï¼" 